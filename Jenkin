pipeline {   environment {
    registry = "957983457697.dkr.ecr.us-east-1.amazonaws.com/e-learning-announcement"

  }
    agent any

    stages {
        stage('git clone') {
            steps {
                git branch: 'ecs-development',
                credentialsId: 'github-cred-brigosha-deba',
                url: 'https://github.com/brigosha/e-learning-announcement.git'
            }
        }
      
        stage ('update orm confsdig') {
            steps {
                sh ''' 
                mv ormconfig.yml back_orm || echo moved
                aws s3 cp s3://ecs-autodeployment/new_organisation/organisation_ormconfig/e-learning-announcement/ormconfig.json .
                echo "]" >> ormconfig.json 
                '''
            }
        }
        stage("docker build") {
            steps {
                script {
                    docker.build registry + ":$BUILD_NUMBER"
                }
            }
        }
        stage("docker push command") {
            steps {
                script {
                    docker.withRegistry("https://712074000287.dkr.ecr.ap-south-1.amazonaws.com", "ecr:ap-south-1:aws_credentials") {
                    docker.image("712074000287.dkr.ecr.ap-south-1.amazonaws.com/e-learning-announcement:$BUILD_NUMBER").push()
                    }
                }
            }
        }
        stage("create task definition") {
            steps {
                sh ''' #!/bin/bash
CLUSTER=" e-learning-test-env"
SERVICE_NAME="e-learning-announcement-service"
IMAGE_VERSION=${BUILD_NUMBER}
TASK_FAMILY="e-learning-announcement-task"


#get details of task defination
aws s3 cp s3://ecs-autodeployment/ecs_task_definition_config/e-learning-announcement-task.json .

# Create a new task definition for this build
sed -e "s/%BUILD_NUMBER%/${BUILD_NUMBER}/g" e-learning-announcement-task.json > updated_task_file.json
aws ecs register-task-definition --family ${TASK_FAMILY} --cli-input-json file://updated_task_file.json
rm updated_task_file.json

# Update the service with the new task definition and desired count
TASK_REVISION=`aws ecs describe-task-definition --task-definition ${TASK_FAMILY} | egrep "revision" | tr "/" " " | awk '{print $2}' | sed 's/"$//' | sed 's/,//g'`
#DESIRED_COUNT=`aws ecs describe-services --cluster ${CLUSTER} --services ${SERVICE_NAME} | egrep "desiredCount" | tr "/" " " | awk '{print $2}' | sed 's/,$//'`

DESIRED_COUNT="1"


aws ecs update-service --cluster ${CLUSTER} --service ${SERVICE_NAME} --task-definition ${TASK_FAMILY}:${TASK_REVISION} --desired-count ${DESIRED_COUNT}
 '''
            }
        }
    }
}
